#!/usr/bin/env bash

set -e
set -x
set -o pipefail

cluster_name=${1:-"postgres"}

rootdir=${PRJ_ROOT:-$(git rev-parse --show-toplevel)}
outdir=${1:-$rootdir/out}

PG_HOME=${PG_HOME:-$outdir/default}
PG_BIN=$PG_HOME/bin
PATH=$PG_BIN:$PATH

cluster_dir=$PG_HOME/var/$cluster_name
data_dir=$cluster_dir/data
log_dir=$cluster_dir/log
log_file=$log_dir/server.log

echo "Starting PostgreSQL cluster $cluster_name"
pg_ctl -D $data_dir -l $log_file start || {
  echo "Failed to start PostgreSQL"
  cat $log_file
  exit 1
}
