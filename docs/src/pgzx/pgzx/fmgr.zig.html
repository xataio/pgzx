<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>pgzx/fmgr.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-kw">const</span> c = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;c.zig&quot;</span>);</span>
<span class="line" id="L4"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> elog = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;elog.zig&quot;</span>);</span>
<span class="line" id="L5"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> args = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;fmgr/args.zig&quot;</span>);</span>
<span class="line" id="L6"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> conv = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;fmgr/conv.zig&quot;</span>);</span>
<span class="line" id="L7"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> varatt = c.varatt;</span>
<span class="line" id="L8"></span>
<span class="line" id="L9"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Pg_magic_struct = c.Pg_magic_struct;</span>
<span class="line" id="L10"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Pg_finfo_record = c.Pg_finfo_record;</span>
<span class="line" id="L11"></span>
<span class="line" id="L12"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> MAGIC = [*c]<span class="tok-kw">const</span> Pg_magic_struct;</span>
<span class="line" id="L13"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> FN_INFO_V1 = [*c]<span class="tok-kw">const</span> Pg_finfo_record;</span>
<span class="line" id="L14"></span>
<span class="line" id="L15"><span class="tok-comment">/// Use PG_MAGIC value to indicate to PostgreSQL that we have a loadable module.</span></span>
<span class="line" id="L16"><span class="tok-comment">/// This value must be returned by a function named `Pg_magic_func`.</span></span>
<span class="line" id="L17"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PG_MAGIC = Pg_magic_struct{</span>
<span class="line" id="L18">    .len = <span class="tok-builtin">@bitCast</span>(<span class="tok-builtin">@as</span>(<span class="tok-type">c_uint</span>, <span class="tok-builtin">@truncate</span>(<span class="tok-builtin">@sizeOf</span>(Pg_magic_struct)))),</span>
<span class="line" id="L19">    .version = <span class="tok-builtin">@divTrunc</span>(c.PG_VERSION_NUM, <span class="tok-builtin">@as</span>(<span class="tok-type">c_int</span>, <span class="tok-number">100</span>)),</span>
<span class="line" id="L20">    .funcmaxargs = c.FUNC_MAX_ARGS,</span>
<span class="line" id="L21">    .indexmaxkeys = c.INDEX_MAX_KEYS,</span>
<span class="line" id="L22">    .namedatalen = c.NAMEDATALEN,</span>
<span class="line" id="L23">    .float8byval = c.FLOAT8PASSBYVAL,</span>
<span class="line" id="L24">    .abi_extra = [<span class="tok-number">32</span>]<span class="tok-type">u8</span>{ <span class="tok-str">'P'</span>, <span class="tok-str">'o'</span>, <span class="tok-str">'s'</span>, <span class="tok-str">'t'</span>, <span class="tok-str">'g'</span>, <span class="tok-str">'r'</span>, <span class="tok-str">'e'</span>, <span class="tok-str">'S'</span>, <span class="tok-str">'Q'</span>, <span class="tok-str">'L'</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span>, <span class="tok-number">0</span> },</span>
<span class="line" id="L25">};</span>
<span class="line" id="L26"></span>
<span class="line" id="L27"><span class="tok-comment">/// Postgres magic indicator that a function uses the v1 UDF API.</span></span>
<span class="line" id="L28"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> PG_FINFO_V1_RECORD = Pg_finfo_record{</span>
<span class="line" id="L29">    .api_version = <span class="tok-number">1</span>,</span>
<span class="line" id="L30">};</span>
<span class="line" id="L31"></span>
<span class="line" id="L32"><span class="tok-comment">/// Magic PostgreSQL symbols to indicate it's a loadable module.</span></span>
<span class="line" id="L33"><span class="tok-comment">///</span></span>
<span class="line" id="L34"><span class="tok-comment">/// We do not export the symbol to postgres. If you want to indicate that you have a loadable module</span></span>
<span class="line" id="L35"><span class="tok-comment">/// use `Pg_magic_func` like so in your module:</span></span>
<span class="line" id="L36"><span class="tok-comment">///</span></span>
<span class="line" id="L37"><span class="tok-comment">///   pub export fn Pg_magic_func() [*c]const pg.Pg_magic_struct {</span></span>
<span class="line" id="L38"><span class="tok-comment">///     return pgzx.Pg_magic_func();</span></span>
<span class="line" id="L39"><span class="tok-comment">///   }</span></span>
<span class="line" id="L40"><span class="tok-comment">///</span></span>
<span class="line" id="L41"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">PG_MODULE_MAGIC</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L42">    <span class="tok-builtin">@export</span>(Pg_magic_func, .{ .name = <span class="tok-str">&quot;Pg_magic_func&quot;</span> });</span>
<span class="line" id="L43">}</span>
<span class="line" id="L44"></span>
<span class="line" id="L45"><span class="tok-kw">fn</span> <span class="tok-fn">Pg_magic_func</span>() <span class="tok-kw">callconv</span>(.C) [*c]<span class="tok-kw">const</span> Pg_magic_struct {</span>
<span class="line" id="L46">    <span class="tok-kw">return</span> &amp;PG_MAGIC;</span>
<span class="line" id="L47">}</span>
<span class="line" id="L48"></span>
<span class="line" id="L49"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">FunctionV1</span>() <span class="tok-kw">callconv</span>(.C) [*c]<span class="tok-kw">const</span> Pg_finfo_record {</span>
<span class="line" id="L50">    <span class="tok-kw">return</span> &amp;PG_FINFO_V1_RECORD;</span>
<span class="line" id="L51">}</span>
<span class="line" id="L52"></span>
<span class="line" id="L53"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">PG_FUNCTION_INFO_V1</span>(<span class="tok-kw">comptime</span> fun: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L54">    <span class="tok-kw">const</span> finfo_name = <span class="tok-str">&quot;pg_finfo_&quot;</span> ++ fun;</span>
<span class="line" id="L55">    <span class="tok-builtin">@export</span>(FunctionV1, .{ .name = finfo_name });</span>
<span class="line" id="L56">}</span>
<span class="line" id="L57"></span>
<span class="line" id="L58"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">PG_FUNCTION_V1</span>(<span class="tok-kw">comptime</span> name: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, <span class="tok-kw">comptime</span> callback: <span class="tok-kw">anytype</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L59">    PG_FUNCTION_INFO_V1(name);</span>
<span class="line" id="L60"></span>
<span class="line" id="L61">    <span class="tok-kw">const</span> reg = genFnCall(callback);</span>
<span class="line" id="L62">    <span class="tok-builtin">@export</span>(reg.call, .{ .name = name });</span>
<span class="line" id="L63">}</span>
<span class="line" id="L64"></span>
<span class="line" id="L65"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">genFnCall</span>(<span class="tok-kw">comptime</span> f: <span class="tok-kw">anytype</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L66">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L67">        <span class="tok-kw">const</span> function: <span class="tok-builtin">@TypeOf</span>(f) = f;</span>
<span class="line" id="L68">        <span class="tok-kw">fn</span> <span class="tok-fn">call</span>(fcinfo: c.FunctionCallInfo) <span class="tok-kw">callconv</span>(.C) c.Datum {</span>
<span class="line" id="L69">            <span class="tok-kw">return</span> pgCall(<span class="tok-builtin">@src</span>(), function, fcinfo);</span>
<span class="line" id="L70">        }</span>
<span class="line" id="L71">    };</span>
<span class="line" id="L72">}</span>
<span class="line" id="L73"></span>
<span class="line" id="L74"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> Arg = args.Arg;</span>
<span class="line" id="L75"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> ArgType = args.ArgType;</span>
<span class="line" id="L76"></span>
<span class="line" id="L77"><span class="tok-kw">pub</span> <span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">pgCall</span>(</span>
<span class="line" id="L78">    <span class="tok-kw">comptime</span> src: std.builtin.SourceLocation,</span>
<span class="line" id="L79">    <span class="tok-kw">comptime</span> impl: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L80">    fcinfo: c.FunctionCallInfo,</span>
<span class="line" id="L81">) c.Datum {</span>
<span class="line" id="L82">    <span class="tok-kw">const</span> fnType = <span class="tok-builtin">@TypeOf</span>(impl);</span>
<span class="line" id="L83">    <span class="tok-kw">const</span> funcArgType = std.meta.ArgsTuple(fnType);</span>
<span class="line" id="L84"></span>
<span class="line" id="L85">    <span class="tok-kw">var</span> callArgs: funcArgType = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L86">    <span class="tok-kw">comptime</span> <span class="tok-kw">var</span> info_idx = <span class="tok-number">0</span>;</span>
<span class="line" id="L87">    <span class="tok-kw">inline</span> <span class="tok-kw">for</span> (std.meta.fields(<span class="tok-builtin">@TypeOf</span>(callArgs)), <span class="tok-number">0</span>..) |field, i| {</span>
<span class="line" id="L88">        <span class="tok-kw">const</span> arg = ArgType(field.<span class="tok-type">type</span>);</span>
<span class="line" id="L89">        callArgs[i] = arg.read(fcinfo, info_idx) <span class="tok-kw">catch</span> |e| elog.throwAsPostgresError(src, e);</span>
<span class="line" id="L90">        <span class="tok-kw">if</span> (arg.consumesArgument()) {</span>
<span class="line" id="L91">            info_idx += <span class="tok-number">1</span>;</span>
<span class="line" id="L92">        }</span>
<span class="line" id="L93">    }</span>
<span class="line" id="L94"></span>
<span class="line" id="L95">    <span class="tok-kw">const</span> value = <span class="tok-builtin">@call</span>(.no_async, impl, callArgs) <span class="tok-kw">catch</span> |e| elog.throwAsPostgresError(src, e);</span>
<span class="line" id="L96">    <span class="tok-kw">const</span> resultConv = conv.find(<span class="tok-builtin">@TypeOf</span>(value));</span>
<span class="line" id="L97">    <span class="tok-kw">const</span> nullableDatum = resultConv.toNullableDatum(value) <span class="tok-kw">catch</span> |e| elog.throwAsPostgresError(src, e);</span>
<span class="line" id="L98">    <span class="tok-kw">if</span> (nullableDatum.isnull) {</span>
<span class="line" id="L99">        fcinfo.*.isnull = <span class="tok-null">true</span>;</span>
<span class="line" id="L100">        <span class="tok-kw">return</span> <span class="tok-number">0</span>;</span>
<span class="line" id="L101">    }</span>
<span class="line" id="L102">    <span class="tok-kw">return</span> nullableDatum.value;</span>
<span class="line" id="L103">}</span>
<span class="line" id="L104"></span>
</code></pre></body>
</html>